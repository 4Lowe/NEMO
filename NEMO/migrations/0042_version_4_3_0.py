# Generated by Django 3.2.14 on 2022-09-06 17:54

import datetime

import django.db.models.deletion
import django.db.models.functions.text
from django.conf import settings
from django.db import migrations, models

from NEMO.migrations_utils import create_news_for_version


class Migration(migrations.Migration):

    dependencies = [
        ('NEMO', '0041_version_4_2_1'),
    ]

    def new_version_news(apps, schema_editor):
        create_news_for_version(apps, "4.3.0", "")

    def migrate_qualifications(apps, schema_editor):
        User = apps.get_model("NEMO", "User")
        Qualification = apps.get_model("NEMO", "Qualification")
        for user in User.objects.all():
            for tool in user.qualifications.all():
                Qualification.objects.create(tool=tool, user=user)

    operations = [
        migrations.RunPython(new_version_news),
        migrations.AddField(
            model_name='interlock',
            name='unit_id',
            field=models.PositiveIntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='interlock',
            name='most_recent_reply_time',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='userpreferences',
            name='email_send_access_expiration_emails',
            field=models.BooleanField(default=True, help_text='Send access expiration emails to my alternate email'),
        ),
        migrations.AddField(
            model_name='user',
            name='notes',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.CreateModel(
            name='Qualification',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('qualified_on', models.DateField(default=datetime.date.today)),
                ('tool', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='NEMO.tool')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.RunPython(migrate_qualifications),
        migrations.AddField(
            model_name='user',
            name='tool_qualifications',
            field=models.ManyToManyField(blank=True, help_text='Select the tools that the user is qualified to use.', through='NEMO.Qualification', to='NEMO.Tool'),
        ),
        migrations.RemoveField(model_name='user', name='qualifications'),
        migrations.RenameField(
            model_name='user',
            old_name='tool_qualifications',
            new_name='qualifications',
        ),
        migrations.AlterModelTable(
            name='qualification',
            table='NEMO_user_qualifications',
        ),
        migrations.AddField(
            model_name='userpreferences',
            name='email_send_tool_qualification_expiration_emails',
            field=models.BooleanField(default=True, help_text='Send tool qualification expiration emails to my alternate email'),
        ),
        migrations.AlterField(
            model_name='alert',
            name='contents',
            field=models.TextField(),
        ),
        migrations.AddField(
            model_name='consumable',
            name='reusable',
            field=models.BooleanField(default=False, help_text='Check this box if this item is reusable. The quantity of reusable items will not decrease when orders are made (storage bins for example).'),
        ),
        migrations.AlterField(
            model_name='consumable',
            name='reminder_email',
            field=models.EmailField(blank=True, help_text='An email will be sent to this address when the quantity of this item falls below the reminder threshold.', max_length=254, null=True),
        ),
        migrations.AlterField(
            model_name='consumable',
            name='reminder_threshold',
            field=models.IntegerField(blank=True, help_text='More of this item should be ordered when the quantity falls below this threshold.', null=True),
        ),
        migrations.AlterField(
            model_name='user',
            name='training_required',
            field=models.BooleanField(default=True, help_text='When selected, the user is blocked from all reservation and tool usage capabilities.', verbose_name='facility rules tutorial required'),
        ),
    ]
